{% extends 'base.html' %}
{% load static %}
{% load monitor_extras %}
{% load l10n %}

{% block header_title %}Calendario de Facturación{% endblock %}
{% block header_subtitle %}{{ mes_nombre }} {{ anio|unlocalize }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <!-- Calendar Controls -->
        <div class="card border mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <a href="{% url 'calendario_mes' prev_anio prev_mes %}" class="btn btn-outline-secondary">
                        <i class="bi bi-chevron-left"></i> {{ prev_mes|stringformat:"02d" }}/{{ prev_anio|unlocalize }}
                    </a>
                    
                    <h4 class="mb-0">{{ mes_nombre }} {{ anio|unlocalize }}</h4>
                    
                    <a href="{% url 'calendario_mes' next_anio next_mes %}" class="btn btn-outline-secondary">
                        {{ next_mes|stringformat:"02d" }}/{{ next_anio|unlocalize }} <i class="bi bi-chevron-right"></i>
                    </a>
                </div>
                
                {% if user.profile.role == 'admin' %}
                <div class="mt-3 text-center">
                    <a href="{% url 'evento_list' %}" class="btn btn-outline-primary me-2">
                        <i class="bi bi-list-ul"></i> Ver Eventos
                    </a>
                    <a href="{% url 'evento_create' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Nuevo Evento
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Color Legend -->
        <div class="card border mb-3">
            <div class="card-body">
                <h6 class="mb-3">Leyenda de Colores</h6>
                <div class="row">
                    <div class="col-md-3 col-6 mb-2">
                        <div class="d-flex align-items-center">
                            <span class="badge me-2" style="background-color: #FFC0CB;">⬤</span>
                            <small class="text-muted">Prefacturación Masiva</small>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-2">
                        <div class="d-flex align-items-center">
                            <span class="badge me-2" style="background-color: #DC2626;">⬤</span>
                            <small class="text-muted">Facturación Masiva</small>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-2">
                        <div class="d-flex align-items-center">
                            <span class="badge me-2" style="background-color: #87CEEB;">⬤</span>
                            <small class="text-muted">Prefacturación Especial</small>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-2">
                        <div class="d-flex align-items-center">
                            <span class="badge me-2" style="background-color: #2563EB;">⬤</span>
                            <small class="text-muted">Facturación Especial</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Grid -->
        <div class="card border">
            <div class="card-body p-0">
                <table class="table table-bordered mb-0">
                    <thead>
                        <tr class="text-center">
                            <th class="py-3">Lun</th>
                            <th class="py-3">Mar</th>
                            <th class="py-3">Mié</th>
                            <th class="py-3">Jue</th>
                            <th class="py-3">Vie</th>
                            <th class="py-3">Sáb</th>
                            <th class="py-3">Dom</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for week in calendar %}
                        <tr>
                            {% for day in week %}
                            <td class="align-top p-2 {% if forloop.counter == 7 %}bg-opacity-10 {% endif %}" style="height: 120px; width: 14.28%; {% if forloop.counter == 7 %}background-color: rgba(108, 117, 125, 0.1);{% endif %}">
                                {% if day != 0 %}
                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                        <span class="badge {% if day == today.day and mes == today.month and anio == today.year %}bg-primary{% else %}bg-secondary{% endif %}">
                                            {{ day }}
                                        </span>
                                    </div>
                                    
                                    <!-- Events for this day -->
                                    {% if day in eventos_por_dia %}
                                        <div class="d-flex flex-column gap-1">
                                            {% for evento in eventos_por_dia|get_item:day %}
                                                <a href="{% url 'equipo_list' %}?porcion={{ evento.porcion_id }}" class="text-decoration-none d-block">
                                                    <div class="badge text-white text-truncate w-100" 
                                                         style="background-color: {{ evento.color }}; font-size: 1.05rem;"
                                                         title="{{ evento.nombre }}">
                                                        {{ evento.porcion }}
                                                    </div>
                                                </a>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
