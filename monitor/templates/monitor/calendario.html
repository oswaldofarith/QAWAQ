{% extends 'base.html' %}
{% load static %}
{% load monitor_extras %}
{% load l10n %}

{% block header_title %}Calendario de Facturación{% endblock %}
{% block header_subtitle %}Gestión de eventos de facturación{% endblock %}

{% block content %}
<style>
    #external-events {
        background: #fff;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        max-height: 600px;
        overflow-y: auto;
    }
    .fc-event {
        cursor: move;
        margin: 5px 0;
        padding: 5px;
        border-radius: 3px;
    }
    .fc-event-main {
        font-size: 0.85em;
    }
    .pending-portion {
        background-color: #f8f9fa;
        border: 1px solid #ced4da;
        padding: 8px;
        margin-bottom: 5px;
        cursor: grab;
        border-radius: 4px;
        font-size: 0.9rem;
    }
    .pending-portion:hover {
        background-color: #e9ecef;
    }
    .fc-day-sun {
        background-color: #e0e0e0;
    }
</style>

<div class="row mb-3">
    <div class="col-12 d-flex justify-content-end">
        <a href="{% url 'evento_list' %}" class="btn btn-outline-primary me-2">
            <i class="bi bi-list-ul"></i> Lista de eventos
        </a>
        {% if is_admin %}
            {% if edit_mode %}
                <a href="?mode=view" class="btn btn-secondary">
                    <i class="bi bi-eye"></i> Salir del Modo Edición
                </a>
            {% else %}
                <a href="?mode=edit" class="btn btn-primary">
                    <i class="bi bi-pencil-square"></i> Modificar Calendario
                </a>
            {% endif %}
        {% endif %}
    </div>
</div>

<div class="row">
    <!-- Sidebar: Pending Portions (Only in Edit Mode) -->
    {% if edit_mode %}
    <div class="col-md-3">
        <div class="card mb-3">
            <div class="card-header bg-warning text-dark">
                <i class="bi bi-hourglass-split"></i> Pendientes <span id="current-month-label"></span>
            </div>
            <div class="card-body p-2">
                <p class="small text-muted mb-2">Arrastra estas porciones al calendario para crear un evento.</p>
                <div id="external-events-list">
                    <!-- Loaded via JS -->
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Legend -->
        <div class="card">
             <div class="card-header">
                Leyenda
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                    <span class="badge me-2" style="background-color: #EF5350;">⬤</span> Masiva
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge me-2" style="background-color: #87CEEB;">⬤</span> Especial
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Calendar Area -->
    <div class="col-md-{% if edit_mode %}9{% else %}12{% endif %}">
        <div class="card">
            <div class="card-body p-2">
                <div id='calendar'></div>
            </div>
        </div>
    </div>
</div>

<!-- FullCalendar CDN -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/locales/es.global.min.js'></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var containerEl = document.getElementById('external-events-list'); // May be null if not edit mode
    var initialDate = "{{ initial_date }}"; // e.g., '2023-10-01'
    var isEditMode = {{ edit_mode|yesno:"true,false" }};

    // Initialize Draggable for the sidebar only if container exists
    if (containerEl) {
        new FullCalendar.Draggable(containerEl, {
            itemSelector: '.pending-portion',
            eventData: function(eventEl) {
                return {
                    title: eventEl.innerText.trim(),
                    backgroundColor: eventEl.dataset.color,
                    borderColor: eventEl.dataset.color,
                    extendedProps: {
                        porcion_id: eventEl.dataset.id
                    }
                };
            }
        });
    }

    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialDate: initialDate,
        initialView: 'dayGridMonth',
        locale: 'es', // Set Spanish locale
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,listMonth'
        },
        editable: isEditMode,
        droppable: isEditMode, // this allows things to be dropped onto the calendar
        events: '{% url "api_get_events" %}', // Fetch events from API
        
        // Receive external drop (Create Event)
        eventReceive: function(info) {
            if (!isEditMode) return;
            
            var event = info.event;
            var date = event.startStr; // ISO string
            var porcion_id = event.extendedProps.porcion_id;
            
            // Call API to create event
            fetch('{% url "api_save_event" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    porcion_id: porcion_id,
                    date: date
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.error) {
                    alert('Error: ' + data.error);
                    event.remove(); // Revert
                } else {
                    event.setProp('id', data.id); // Set the real ID
                    refreshPendingPortions(calendar.getDate()); // Update sidebar
                }
            })
            .catch(error => {
                console.error('Error:', error);
                event.remove();
                alert('Ocurrió un error al guardar el evento.');
            });
        },

        // Move event (Update Date)
        eventDrop: function(info) {
            if (!isEditMode) {
                info.revert();
                return;
            }

            var event = info.event;
            var newDate = event.startStr;
            
            fetch('{% url "api_update_event" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    event_id: event.id,
                    date: newDate
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.error) {
                    alert('Error: ' + data.error);
                    info.revert();
                } else {
                     // Check if month changed significantly to refresh pending list?
                     // Usually just keep it compatible.
                     refreshPendingPortions(calendar.getDate());
                }
            })
            .catch(error => {
                console.error('Error:', error);
                info.revert();
                alert('Error al actualizar el evento.');
            });
        },
        
        // Handle clicking an event (Maybe redirect to logs or show details?)
        eventClick: function(info) {
            if (!isEditMode) return; // Do nothing in read-only mode, or show details?

            if (confirm("¿Deseas eliminar este evento de facturación? Volverá a la lista de pendientes.")) {
                 fetch('{% url "api_delete_event" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        event_id: info.event.id
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if(data.status === 'success') {
                        info.event.remove();
                        refreshPendingPortions(calendar.getDate());
                    } else {
                        alert('Error al eliminar: ' + data.error);
                    }
                });
            }
        },

        datesSet: function(info) {
            // Called when the view changes (e.g. month change)
            refreshPendingPortions(info.view.currentStart);
        }
    });

    calendar.render();

    function refreshPendingPortions(dateObj) {
        if (!containerEl) return; // Exit if sidebar doesn't exist

        // format date as YYYY-MM-DD
        var dateStr = dateObj.toISOString().split('T')[0];
        
        fetch('{% url "api_get_pending_portions" %}?date=' + dateStr)
        .then(response => response.json())
        .then(data => {
            containerEl.innerHTML = '';
            if (data.length === 0) {
                containerEl.innerHTML = '<div class="text-muted text-center small">No hay pendientes para este mes</div>';
                return;
            }
            
            data.forEach(item => {
                var div = document.createElement('div');
                div.className = 'pending-portion fc-event';
                div.dataset.id = item.id;
                div.dataset.color = item.color; // store color for drag
                
                // Content
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>${item.title}</strong>
                        <span class="badge bg-secondary rounded-pill">${item.medidores_count}</span>
                    </div>
                    <div class="small text-muted" style="font-size: 0.75rem;">${item.tipo}</div>
                `;
                
                containerEl.appendChild(div);
            });
        });
    }

});
</script>
{% endblock %}
