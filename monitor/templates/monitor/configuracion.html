{% extends 'base.html' %}

{% block header_title %}Configuración del Sistema{% endblock %}
{% block header_subtitle %}Parámetros globales de monitoreo{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card-dashboard p-4">
            <h5 class="text-white mb-4">
                <i class="bi bi-gear-fill me-2"></i>Configuración Global
            </h5>

            <form method="post">
                {% csrf_token %}

                <div class="row g-3">
                    <!-- Tiempo Interrogación -->
                    <div class="col-md-6">
                        <label for="id_tiempo_interrogacion" class="form-label text-white">
                            {{ form.tiempo_interrogacion.label }}
                        </label>
                        {{ form.tiempo_interrogacion }}
                        <small class="text-secondary d-block mt-1">Intervalo entre pings automáticos</small>
                        {% if form.tiempo_interrogacion.errors %}
                        <div class="text-danger small mt-1">{{ form.tiempo_interrogacion.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- Reintentos -->
                    <div class="col-md-6">
                        <label for="id_reintentos" class="form-label text-white">
                            {{ form.reintentos.label }}
                        </label>
                        {{ form.reintentos }}
                        <small class="text-secondary d-block mt-1">Intentos antes de marcar offline</small>
                        {% if form.reintentos.errors %}
                        <div class="text-danger small mt-1">{{ form.reintentos.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- Umbral Fibra -->
                    <div class="col-md-6">
                        <label for="id_umbral_falla_fibra" class="form-label text-white">
                            {{ form.umbral_falla_fibra.label }}
                        </label>
                        {{ form.umbral_falla_fibra }}
                        <small class="text-secondary d-block mt-1">Timeout para equipos de fibra óptica</small>
                        {% if form.umbral_falla_fibra.errors %}
                        <div class="text-danger small mt-1">{{ form.umbral_falla_fiber.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- Umbral Celular -->
                    <div class="col-md-6">
                        <label for="id_umbral_falla_celular" class="form-label text-white">
                            {{ form.umbral_falla_celular.label }}
                        </label>
                        {{ form.umbral_falla_celular }}
                        <small class="text-secondary d-block mt-1">Timeout para equipos celulares (4G/5G)</small>
                        {% if form.umbral_falla_celular.errors %}
                        <div class="text-danger small mt-1">{{ form.umbral_falla_celular.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-2"></i>Guardar Configuración
                    </button>
                </div>
            </form>
        </div>

        <!-- Current Values Info -->
        <div class="card-dashboard p-4 mt-4">
            <h6 class="text-white mb-3">Valores Actuales</h6>
            <div class="row g-3">
                <div class="col-md-6">
                    <small class="text-secondary">Intervalo de Ping:</small>
                    <div class="text-white">{{ config.tiempo_interrogacion }} segundos</div>
                </div>
                <div class="col-md-6">
                    <small class="text-secondary">Reintentos:</small>
                    <div class="text-white">{{ config.reintentos }}</div>
                </div>
                <div class="col-md-6">
                    <small class="text-secondary">Umbral Fibra:</small>
                    <div class="text-white">{{ config.umbral_falla_fibra }} segundos</div>
                </div>
                <div class="col-md-6">
                    <small class="text-secondary">Umbral Celular:</small>
                    <div class="text-white">{{ config.umbral_falla_celular }} segundos</div>
                </div>
            </div>
        </div>
        
        <!-- Telegram Notifications Configuration -->
        <div class="card-dashboard p-4 mt-4">
            <h6 class="text-white mb-3">
                <i class="bi bi-telegram me-2"></i>Configuración de Telegram
            </h6>
            <p class="text-secondary small mb-3">
                Configura el bot de Telegram para enviar notificaciones de equipos críticos
            </p>
            
            <div class="mb-3">
                <label class="form-label text-white">Estado del Bot</label>
                <div>
                    {% if telegram_enabled %}
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle me-1"></i>Habilitado
                        </span>
                    {% else %}
                        <span class="badge bg-warning">
                            <i class="bi bi-exclamation-triangle me-1"></i>No configurado
                        </span>
                    {% endif %}
                </div>
            </div>
            
            <div class="alert alert-info" role="alert">
                <h6 class="alert-heading"><i class="bi bi-info-circle me-2"></i>Configuración del Bot</h6>
                <p class="mb-2">Para configurar las notificaciones de Telegram:</p>
                <ol class="mb-2">
                    <li>Crea un bot con <strong>@BotFather</strong> en Telegram</li>
                    <li>Copia el token del bot</li>
                    <li>Agrégalo a tu archivo <code>.env</code>:
                        <pre class="bg-dark text-light p-2 rounded mt-1"><code>TELEGRAM_BOT_TOKEN=tu_bot_token_aquí
TELEGRAM_ENABLED=True</code></pre>
                    </li>
                    <li>Reinicia el servidor Django</li>
                    <li>Cada usuario debe configurar su Chat ID en <strong>Mi Perfil</strong></li>
                </ol>
                <p class="mb-0 small">
                    <strong>Prueba tu configuración:</strong>
                    <code>python manage.py test_telegram --check</code>
                </p>
            </div>
            
            {% if telegram_enabled and telegram_bot_info %}
            <div class="alert alert-success" role="alert">
                <h6 class="alert-heading"><i class="bi bi-check-circle me-2"></i>Bot Conectado</h6>
                <div class="row g-2">
                    <div class="col-md-6">
                        <small class="text-muted">Nombre del Bot:</small>
                        <div><strong>{{ telegram_bot_info.bot_name }}</strong></div>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted">Username:</small>
                        <div><strong>@{{ telegram_bot_info.bot_username }}</strong></div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
