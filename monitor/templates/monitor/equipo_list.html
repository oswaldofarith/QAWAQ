{% extends 'base.html' %}
{% load monitor_extras %}

{% block header_title %}Listado de Equipos{% endblock %}
{% block header_subtitle %}Gestión de inventario de red • {{ total_active }} Dispositivos Activos{% endblock %}

{% block content %}
<!-- Header Actions & Search -->
<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <div><!-- Spacer --></div>
        <div class="d-flex gap-2">
            {% if user.profile.role == 'admin' %}
            <a href="{% url 'import_equipos' %}" class="btn btn-outline-primary">
                <i class="bi bi-upload me-2"></i>Importación masiva
            </a>
            <a href="{% url 'equipo_create' %}" class="btn btn-primary">
                <i class="bi bi-plus-lg me-2"></i>Nuevo Equipo
            </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Filters Panel -->
<div class="card-dashboard p-4 mb-4">
    <div class="row g-3 mb-3">
        <!-- Search -->
        <div class="col-md-8">
            <div class="position-relative">
                <span class="position-absolute ms-3 top-50 translate-middle-y text-secondary">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" name="q" class="form-control bg-dark border-secondary text-white ps-5"
                    placeholder="Buscar por ID, Hostname o Dirección IP..." value="{{ request.GET.q|default:'' }}"
                    hx-get="{% url 'equipo_list' %}"
                    hx-trigger="keyup changed delay:500ms" hx-target="#equipos-list-container" hx-swap="innerHTML"
                    hx-include="[name='marca'], [name='medio'], [name='estado'], [name='tipo'], [name='comunicacion'], [name='porcion']"
                    autocomplete="off">
            </div>
        </div>
        <!-- Type Filter Button (Visual placeholder for specific modal/dropdown, mapped to select for now) -->
        <div class="col-md-4">
            <select name="tipo" class="form-select bg-dark border-secondary text-white" hx-get="{% url 'equipo_list' %}"
                hx-trigger="change" hx-target="#equipos-list-container" hx-swap="innerHTML"
                hx-include="[name='q'], [name='marca'], [name='medio'], [name='estado'], [name='comunicacion'], [name='porcion']">
                <option value="">Filtrar por Tipo</option>
                {% for tipo in tipos %}
                <option value="{{ tipo.id }}" {% if request.GET.tipo == tipo.id|stringformat:"s" %}selected{% endif %}>{{ tipo.nombre }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Quick Filters -->
    <div class="d-flex flex-wrap gap-3 align-items-center">
        <span class="text-secondary small me-2">Filtros Rápidos:</span>

        <!-- Marca -->
        <select name="marca" class="form-select form-select-sm bg-dark border-secondary text-white w-auto"
            hx-get="{% url 'equipo_list' %}" hx-trigger="change" hx-target="#equipos-list-container" hx-swap="innerHTML"
            hx-include="[name='q'], [name='medio'], [name='estado'], [name='tipo'], [name='comunicacion'], [name='porcion']">
            <option value="">Marca: Todas</option>
            {% for marca in marcas %}
            <option value="{{ marca.id }}" {% if request.GET.marca == marca.id|stringformat:"s" %}selected{% endif %}>{{ marca.nombre }}</option>
            {% endfor %}
        </select>
        
        <!-- Porción -->
        <select name="porcion" class="form-select form-select-sm bg-dark border-secondary text-white w-auto"
            hx-get="{% url 'equipo_list' %}" hx-trigger="change" hx-target="#equipos-list-container" hx-swap="innerHTML"
            hx-include="[name='q'], [name='marca'], [name='medio'], [name='estado'], [name='tipo'], [name='comunicacion']">
            <option value="">Porción: Todas</option>
            {% for porcion in porciones %}
            <option value="{{ porcion.id }}" {% if request.GET.porcion == porcion.id|stringformat:"s" %}selected{% endif %}>{{ porcion.nombre }}</option>
            {% endfor %}
        </select>
        
        <!-- Medio -->
        <select name="medio" class="form-select form-select-sm bg-dark border-secondary text-white w-auto"
            hx-get="{% url 'equipo_list' %}" hx-trigger="change" hx-target="#equipos-list-container" hx-swap="innerHTML"
            hx-include="[name='q'], [name='marca'], [name='estado'], [name='tipo'], [name='comunicacion'], [name='porcion']">
            <option value="">Medio: Todos</option>
            <option value="FIBRA" {% if request.GET.medio == 'FIBRA' %}selected{% endif %}>Fibra</option>
            <option value="CELULAR" {% if request.GET.medio == 'CELULAR' %}selected{% endif %}>Celular</option>
        </select>

        <!-- Estado -->
        <select name="estado" class="form-select form-select-sm bg-dark border-secondary text-white w-auto"
            hx-get="{% url 'equipo_list' %}" hx-trigger="change" hx-target="#equipos-list-container" hx-swap="innerHTML"
            hx-include="[name='q'], [name='marca'], [name='medio'], [name='tipo'], [name='comunicacion'], [name='porcion']">
            <option value="">Estado: Todos</option>
            <option value="ACTIVO" {% if request.GET.estado == 'ACTIVO' %}selected{% endif %}>Activo</option>
            <option value="INACTIVO" {% if request.GET.estado == 'INACTIVO' %}selected{% endif %}>Inactivo</option>
        </select>

        <!-- Comunicación -->
        <select name="comunicacion" class="form-select form-select-sm bg-dark border-secondary text-white w-auto"
            hx-get="{% url 'equipo_list' %}" hx-trigger="change" hx-target="#equipos-list-container" hx-swap="innerHTML"
            hx-include="[name='q'], [name='marca'], [name='medio'], [name='estado'], [name='tipo'], [name='porcion']">
            <option value="">Comunicación: Todos</option>
            <option value="ONLINE" {% if request.GET.comunicacion == 'ONLINE' %}selected{% endif %}>Online</option>
            <option value="OFFLINE" {% if request.GET.comunicacion == 'OFFLINE' %}selected{% endif %}>Offline</option>
        </select>

        <a href="{% url 'equipo_list' %}" class="btn btn-link btn-sm text-decoration-none text-primary ms-auto">
            Limpiar Filtros
        </a>
    </div>
</div>

<!-- Table Container (Target for Full Refresh) -->
<div id="equipos-list-container" class="card-dashboard p-0 overflow-hidden">
    {% include 'monitor/partials/equipo_list_content.html' %}
</div>
{% endblock %}