{% extends 'base.html' %}
{% load monitor_extras %}

{% block header_title %}Listado de Equipos{% endblock %}
{% block header_subtitle %}Gestión de inventario de red • {{ total_active }} Dispositivos Activos{% endblock %}

{% block content %}
<!-- Header Actions & Search -->
<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <div><!-- Spacer --></div>
        <div class="d-flex gap-2">
            {% if user.profile.role == 'admin' %}
            <a href="{% url 'import_equipos' %}" class="btn btn-outline-primary">
                <i class="bi bi-upload me-2"></i>Importación masiva
            </a>
            <a href="{% url 'equipo_create' %}" class="btn btn-primary">
                <i class="bi bi-plus-lg me-2"></i>Nuevo Equipo
            </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Filters Panel -->
<div class="card-dashboard p-4 mb-4">
    <div class="row g-3 mb-3">
        <!-- Search -->
        <div class="col-md-8">
            <div class="position-relative">
                <span class="position-absolute ms-3 top-50 translate-middle-y text-secondary">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" name="q" class="form-control bg-dark border-secondary text-white ps-5"
                    placeholder="Buscar por ID, Hostname o Dirección IP..." hx-get="{% url 'equipo_list' %}"
                    hx-trigger="keyup changed delay:500ms" hx-target="#equipos-table-body"
                    hx-include="[name='marca'], [name='medio'], [name='estado'], [name='tipo'], [name='comunicacion']"
                    autocomplete="off">
            </div>
        </div>
        <!-- Type Filter Button (Visual placeholder for specific modal/dropdown, mapped to select for now) -->
        <div class="col-md-4">
            <select name="tipo" class="form-select bg-dark border-secondary text-white" hx-get="{% url 'equipo_list' %}"
                hx-trigger="change" hx-target="#equipos-table-body"
                hx-include="[name='q'], [name='marca'], [name='medio'], [name='estado'], [name='comunicacion']">
                <option value="">Filtrar por Tipo</option>
                {% for tipo in tipos %}
                <option value="{{ tipo.id }}">{{ tipo.nombre }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Quick Filters -->
    <div class="d-flex flex-wrap gap-3 align-items-center">
        <span class="text-secondary small me-2">Filtros Rápidos:</span>

        <!-- Marca -->
        <select name="marca" class="form-select form-select-sm bg-dark border-secondary text-white w-auto"
            hx-get="{% url 'equipo_list' %}" hx-trigger="change" hx-target="#equipos-table-body"
            hx-include="[name='q'], [name='medio'], [name='estado'], [name='tipo'], [name='comunicacion']">
            <option value="">Marca: Todas</option>
            {% for marca in marcas %}
            <option value="{{ marca.id }}">{{ marca.nombre }}</option>
            {% endfor %}
        </select>

        <!-- Medio -->
        <select name="medio" class="form-select form-select-sm bg-dark border-secondary text-white w-auto"
            hx-get="{% url 'equipo_list' %}" hx-trigger="change" hx-target="#equipos-table-body"
            hx-include="[name='q'], [name='marca'], [name='estado'], [name='tipo'], [name='comunicacion']">
            <option value="">Medio: Todos</option>
            <option value="FIBRA">Fibra</option>
            <option value="CELULAR">Celular</option>
        </select>

        <!-- Estado -->
        <select name="estado" class="form-select form-select-sm bg-dark border-secondary text-white w-auto"
            hx-get="{% url 'equipo_list' %}" hx-trigger="change" hx-target="#equipos-table-body"
            hx-include="[name='q'], [name='marca'], [name='medio'], [name='tipo'], [name='comunicacion']">
            <option value="">Estado: Todos</option>
            <option value="ACTIVO">Activo</option>
            <option value="INACTIVO">Inactivo</option>
        </select>

        <!-- Comunicación -->
        <select name="comunicacion" class="form-select form-select-sm bg-dark border-secondary text-white w-auto"
            hx-get="{% url 'equipo_list' %}" hx-trigger="change" hx-target="#equipos-table-body"
            hx-include="[name='q'], [name='marca'], [name='medio'], [name='estado'], [name='tipo']">
            <option value="">Comunicación: Todos</option>
            <option value="ONLINE">Online</option>
            <option value="OFFLINE">Offline</option>
        </select>

        <a href="{% url 'equipo_list' %}" class="btn btn-link btn-sm text-decoration-none text-primary ms-auto">
            Limpiar Filtros
        </a>
    </div>
</div>

<!-- Table -->
<div class="card-dashboard p-0 overflow-hidden">
    <div class="table-responsive">
        <table class="table table-custom table-hover mb-0">
            <thead>
                <tr>
                    <th class="ps-4">ID</th>
                    <th>DIRECCIÓN IP</th>

                    <th>TIPO</th>
                    <th>MARCA</th>
                    <th>MEDIO</th>
                    <th>COMUNICACIÓN</th>
                    <th>ÚLTIMA COM.</th>
                    <th>LATENCIA</th>
                    <th class="text-end pe-4">ACCIONES</th>
                </tr>
            </thead>
            <tbody id="equipos-table-body">
                {% include 'monitor/partials/equipo_list_rows.html' %}
            </tbody>
        </table>
    </div>
    <!-- Pagination (Simple) -->
    <div class="p-3 border-top border-secondary border-opacity-25 d-flex justify-content-between align-items-center">
        <span class="text-secondary small">Mostrando {{ page_obj.start_index }} a {{ page_obj.end_index }} de {{
            page_obj.paginator.count }} resultados</span>
        <div>
            {% if page_obj.has_previous %}
            <button class="btn btn-outline-secondary btn-sm me-1"
                hx-get="{% url 'equipo_list' %}?page={{ page_obj.previous_page_number }}"
                hx-target="#equipos-table-body"
                hx-include="[name='q'], [name='marca'], [name='medio'], [name='estado'], [name='tipo'], [name='comunicacion']">
                Anterior
            </button>
            {% endif %}

            {% if page_obj.has_next %}
            <button class="btn btn-outline-secondary btn-sm"
                hx-get="{% url 'equipo_list' %}?page={{ page_obj.next_page_number }}" hx-target="#equipos-table-body"
                hx-include="[name='q'], [name='marca'], [name='medio'], [name='estado'], [name='tipo'], [name='comunicacion']">
                Siguiente
            </button>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}