{% extends 'base.html' %}
{% load static %}

{% block header_title %}Mapa de Equipos{% endblock %}
{% block header_subtitle %}{{ total_equipos }} equipos en la red{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Leaflet MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
    #map {
        height: calc(100vh - 200px);
        min-height: 500px;
        border-radius: 8px;
    }
    
    .filter-panel {
        background: var(--bs-body-bg);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .leaflet-popup-content-wrapper {
        background: var(--bs-body-bg);
        color: var(--bs-body-color);
    }
    
    .leaflet-popup-tip {
        background: var(--bs-body-bg);
    }
    
    .status-badge-online {
        background-color: #28a745;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.875rem;
    }
    
    .status-badge-offline {
        background-color: #dc3545;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.875rem;
    }
    
    /* Custom cluster styles */
    .marker-cluster-custom {
        text-align: center;
    }
    
    .marker-cluster-custom div {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        font-size: 14px;
        border: 3px solid rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<!-- Filtros -->
<div class="filter-panel">
    <form method="get" class="row g-3 align-items-end">
        <div class="col-md-2">
            <label class="form-label">Filtrar por Marca</label>
            <select name="marca" class="form-select" onchange="this.form.submit()">
                <option value="">Todas</option>
                {% for marca in marcas %}
                <option value="{{ marca.id }}" {% if marca_filter|stringformat:"s" == marca.id|stringformat:"s" %}selected{% endif %}>
                    {{ marca.nombre }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Filtrar por Medio</label>
            <select name="medio" class="form-select" onchange="this.form.submit()">
                <option value="">Todos</option>
                <option value="FIBRA" {% if medio_filter == "FIBRA" %}selected{% endif %}>Fibra</option>
                <option value="CELULAR" {% if medio_filter == "CELULAR" %}selected{% endif %}>Celular</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">Filtrar por Porci√≥n</label>
            <select name="porcion" class="form-select" onchange="this.form.submit()">
                <option value="">Todas las porciones</option>
                {% for porcion in porciones %}
                <option value="{{ porcion.id }}" {% if porcion_filter|stringformat:"s" == porcion.id|stringformat:"s" %}selected{% endif %}>
                    {{ porcion.nombre }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Filtrar por Estado</label>
            <select name="estado" class="form-select" onchange="this.form.submit()">
                <option value="">Todos</option>
                <option value="ONLINE" {% if estado_filter == "ONLINE" %}selected{% endif %}>Online</option>
                <option value="OFFLINE" {% if estado_filter == "OFFLINE" %}selected{% endif %}>Offline</option>
            </select>
        </div>
        <div class="col-md-3">
            <div class="d-flex gap-2">
                <a href="{% url 'mapa' %}" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-x-circle"></i> Limpiar
                </a>
                <div class="form-check form-switch bg-dark-subtle border border-secondary rounded p-2 px-3 d-flex align-items-center gap-2" style="min-width: 160px;">
                    <input class="form-check-input ms-0" type="checkbox" id="clusterToggle" checked>
                    <label class="form-check-label mb-0 small text-nowrap" for="clusterToggle">Agrupar</label>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Mapa -->
<div class="card">
    <div class="card-body p-0">
        <div id="map"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Leaflet MarkerCluster JS -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. Initialize Map
    const map = L.map('map').setView([-2.19, -79.89], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);

    const guayaquilBounds = [[-2.35, -80.15], [-1.95, -79.65]];
    map.setMaxBounds(guayaquilBounds);

    // 2. Data from Django
    const equiposData = {{ equipos_json|safe }};
    
    // 3. Layer Managers
    let clusterGroup = null;
    let simpleGroup = null;

    // 4. Icon factories
    function createIcon(color) {
        return L.divIcon({
            className: 'custom-div-icon',
            html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.5);"></div>`,
            iconSize: [16, 16],
            iconAnchor: [8, 8]
        });
    }

    function getClusterIcon(cluster) {
        const childMarkers = cluster.getAllChildMarkers();
        let offlineCount = 0, onlineCount = 0;
        childMarkers.forEach(marker => {
            if (marker.options.equipoData.color === 'red') offlineCount++;
            else if (marker.options.equipoData.color === 'green') onlineCount++;
        });

        let clusterColor;
        if (offlineCount === 0) clusterColor = '#28a745';
        else if (offlineCount <= 2 && onlineCount > 0) clusterColor = '#ffc107';
        else clusterColor = '#dc3545';

        return L.divIcon({
            html: `<div style="background-color: ${clusterColor};"><span>${cluster.getChildCount()}</span></div>`,
            className: 'marker-cluster-custom',
            iconSize: L.point(40, 40)
        });
    }

    function createMarker(equipo) {
        const icon = createIcon(equipo.color);
        const marker = L.marker([equipo.lat, equipo.lng], { 
            icon: icon,
            equipoData: equipo 
        });
        
        const statusClass = equipo.color === 'green' ? 'status-badge-online' : 'status-badge-offline';
        const popupContent = `
            <div style="min-width: 200px;">
                <h6 class="mb-2"><i class="bi bi-router"></i> ${equipo.id_equipo}</h6>
                <table class="table table-sm table-borderless mb-0">
                    <tr><td><strong>Estado:</strong></td><td><span class="${statusClass}">${equipo.estado}</span></td></tr>
                    <tr><td><strong>IP:</strong></td><td class="font-monospace">${equipo.ip}</td></tr>
                    <tr><td><strong>Marca:</strong></td><td>${equipo.marca}</td></tr>
                    <tr><td><strong>Tipo:</strong></td><td>${equipo.tipo}</td></tr>
                </table>
                <div class="mt-2">
                    <a href="/equipos/${equipo.id}/" class="btn btn-sm btn-info w-100" style="color: white;">
                        <i class="bi bi-info-circle"></i> Detalles
                    </a>
                </div>
            </div>`;
        marker.bindPopup(popupContent);
        return marker;
    }

    // 5. Render Core
    function renderMarkers() {
        // Clear previous layers
        if (clusterGroup) map.removeLayer(clusterGroup);
        if (simpleGroup) map.removeLayer(simpleGroup);

        const useClustering = document.getElementById('clusterToggle').checked;
        localStorage.setItem('mapClustering', useClustering);

        if (useClustering) {
            clusterGroup = L.markerClusterGroup({
                chunkedLoading: true,
                maxClusterRadius: 50,
                iconCreateFunction: getClusterIcon
            });
            equiposData.forEach(e => clusterGroup.addLayer(createMarker(e)));
            map.addLayer(clusterGroup);
        } else {
            simpleGroup = L.layerGroup();
            equiposData.forEach(e => simpleGroup.addLayer(createMarker(e)));
            map.addLayer(simpleGroup);
        }

        // Adjust view if markers exist
        if (equiposData.length > 0) {
            const bounds = useClustering ? clusterGroup.getBounds() : L.featureGroup(simpleGroup.getLayers()).getBounds();
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    }

    // 6. Events & Init
    const toggle = document.getElementById('clusterToggle');
    const savedSetting = localStorage.getItem('mapClustering');
    
    if (savedSetting !== null) {
        toggle.checked = savedSetting === 'true';
    }

    toggle.addEventListener('change', renderMarkers);
    renderMarkers(); // First run
});
</script>
{% endblock %}
